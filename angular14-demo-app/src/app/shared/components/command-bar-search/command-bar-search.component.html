<!--
 * Copyright (c) 2023 Robert Bosch Manufacturing Solutions GmbH
 *
 * See the AUTHORS file(s) distributed with this work for
 * additional information regarding authorship.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 *
 * SPDX-License-Identifier: MPL-2.0
 -->

<div class="js-sdk-component-container">
  <command-bar
    [isMultipleSelectionEnabled]="isMultipleSelectionEnabled"
    [allowedCharacters]="allowedCharacters"
    [minNumberCharacters]="minNumberCharacters"
    [maxNumberCharacters]="maxNumberCharacters"
    [searchHint]="searchHint"
    [configs]="configs"
    [KEY_LOCAL_STORAGE_COMMAND_BAR_SEARCH_CONFIG]="KEY_LOCAL_STORAGE_COMMAND_BAR_SEARCH_CONFIG"
    (setConfiguration)="setConfiguration($event)"
    (applyFilters)="applyFilters()"
    (reloadFilter)="reloadFilter()"
    (exportToCsv)="exportToCsv()"
  ></command-bar>

  <ng-container *ngIf="!!customTemplate && !dataSource.data.length">
    <ng-container *ngTemplateOutlet="loadCustomTemplate()"></ng-container>
  </ng-container>

  <chip-list (removeFilter)="removeFilter($event)"></chip-list>

  <div [hidden]="!!customTemplate && !dataSource.data.length">
    <div data-test="table-container" class="mat-table-container">
      <table
        data-test="table"
        mat-table
        class="full-width-table"
        matSortDisableClear="true"
        matSort
        (matSortChange)="sortData()"
        [matSortActive]="columnToSort.sortColumnName"
        [matSortDirection]="columnToSort.sortDirection"
        [ngClass]="customTableClass"
        [dataSource]="dataSource"
        [trackBy]="trackBy"
        aria-label="Elements"
        [matSortDisabled]="dragging"
      >
        <!-- Row shown when there is no matching data that will be provided to the wrapper table. -->
        <tr data-test="no-data-table-row" class="mat-row" *matNoDataRow>
          <td data-test="no-data-table-cell" class="mat-cell" [colSpan]="displayedColumns.length" *ngIf="!dataSource.data.length">
            <span data-test="no-data-message">{{ noDataMessage || 'No data' }}</span>
          </td>
        </tr>

        <!-- moving Column -->
        <ng-container data-test="table-column" matColumnDef="moving">
          <th
            data-test="table-header"
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header="moving"
            [resizeColumn]="true"
            [index]="0"
            (dragging)="dragging = $event"
          >
            <span
              [matTooltip]="'moving.description' | translate"
              [matTooltipDisabled]="headerTooltipsOff"
              matTooltipPosition="above"
              data-test="table-header-text"
            >
              {{ 'moving.preferredName' | translate }}
            </span>
          </th>

          <td data-test="table-cell" mat-cell *matCellDef="let row">
            <ng-container
              [ngTemplateOutlet]="
                highlightConfig?.selected &&
                ((!(row.moving === null || row.moving === undefined) ? row.moving : '-') | searchString : highlightString)
                  ? searchedWordExists
                  : normal
              "
              [ngTemplateOutletContext]="{value: !(row.moving === null || row.moving === undefined) ? row.moving : '-'}"
            ></ng-container>

            <button
              data-test="copy-to-clipboard-button"
              *ngIf="!(row.moving === null || row.moving === undefined)"
              mat-icon-button
              class="copy-to-clipboard"
              (click)="copyToClipboard(row.moving, $event)"
            >
              <mat-icon data-test="copy-to-clipboard-icon" class="material-icons">content_copy</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- speedLimitWarning Column -->
        <ng-container data-test="table-column" matColumnDef="speedLimitWarning">
          <th
            data-test="table-header"
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header="speedLimitWarning"
            [resizeColumn]="true"
            [index]="1"
            (dragging)="dragging = $event"
          >
            <span
              [matTooltip]="'speedLimitWarning.description' | translate"
              [matTooltipDisabled]="headerTooltipsOff"
              matTooltipPosition="above"
              data-test="table-header-text"
            >
              {{ 'speedLimitWarning.preferredName' | translate }}
            </span>
          </th>

          <td data-test="table-cell" mat-cell *matCellDef="let row">
            <ng-container
              [ngTemplateOutlet]="
                highlightConfig?.selected &&
                ((!(row.speedLimitWarning === null || row.speedLimitWarning === undefined) ? row.speedLimitWarning : '-')
                  | searchString : highlightString)
                  ? searchedWordExists
                  : normal
              "
              [ngTemplateOutletContext]="{
                value: !(row.speedLimitWarning === null || row.speedLimitWarning === undefined) ? row.speedLimitWarning : '-'
              }"
            ></ng-container>

            <button
              data-test="copy-to-clipboard-button"
              *ngIf="!(row.speedLimitWarning === null || row.speedLimitWarning === undefined)"
              mat-icon-button
              class="copy-to-clipboard"
              (click)="copyToClipboard(row.speedLimitWarning, $event)"
            >
              <mat-icon data-test="copy-to-clipboard-icon" class="material-icons">content_copy</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- startDate Column -->
        <ng-container data-test="table-column" matColumnDef="startDate">
          <th data-test="table-header" mat-header-cell *matHeaderCellDef mat-sort-header="startDate">
            <span
              [matTooltip]="'startDate.description' | translate"
              [matTooltipDisabled]="headerTooltipsOff"
              matTooltipPosition="above"
              data-test="table-header-text"
            >
              {{ 'startDate.preferredName' | translate }}
            </span>
          </th>

          <td data-test="table-cell" mat-cell *matCellDef="let row">
            <ng-container
              [ngTemplateOutlet]="
                highlightConfig?.selected &&
                ((!(row.startDate === null || row.startDate === undefined) ? (row.startDate | date : tableDateTimeFormat) : '-')
                  | searchString : highlightString)
                  ? searchedWordExists
                  : normal
              "
              [ngTemplateOutletContext]="{
                value: !(row.startDate === null || row.startDate === undefined) ? (row.startDate | date : tableDateTimeFormat) : '-'
              }"
            ></ng-container>

            <button
              data-test="copy-to-clipboard-button"
              *ngIf="!(row.startDate === null || row.startDate === undefined)"
              mat-icon-button
              class="copy-to-clipboard"
              (click)="copyToClipboard(row.startDate, $event)"
            >
              <mat-icon data-test="copy-to-clipboard-icon" class="material-icons">content_copy</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- endDate Column -->
        <ng-container data-test="table-column" matColumnDef="endDate">
          <th data-test="table-header" mat-header-cell *matHeaderCellDef mat-sort-header="endDate">
            <span
              [matTooltip]="'endDate.description' | translate"
              [matTooltipDisabled]="headerTooltipsOff"
              matTooltipPosition="above"
              data-test="table-header-text"
            >
              {{ 'endDate.preferredName' | translate }}
            </span>
          </th>

          <td data-test="table-cell" mat-cell *matCellDef="let row">
            <ng-container
              [ngTemplateOutlet]="
                highlightConfig?.selected &&
                ((!(row.endDate === null || row.endDate === undefined) ? (row.endDate | date : tableDateTimeFormat) : '-')
                  | searchString : highlightString)
                  ? searchedWordExists
                  : normal
              "
              [ngTemplateOutletContext]="{
                value: !(row.endDate === null || row.endDate === undefined) ? (row.endDate | date : tableDateTimeFormat) : '-'
              }"
            ></ng-container>

            <button
              data-test="copy-to-clipboard-button"
              *ngIf="!(row.endDate === null || row.endDate === undefined)"
              mat-icon-button
              class="copy-to-clipboard"
              (click)="copyToClipboard(row.endDate, $event)"
            >
              <mat-icon data-test="copy-to-clipboard-icon" class="material-icons">content_copy</mat-icon>
            </button>
          </td>
        </ng-container>

        <ng-container data-test="columns-menu-button-header" matColumnDef="columnsMenu" stickyEnd>
          <th data-test="columns-menu-button-header" mat-header-cell *matHeaderCellDef>
            <button
              data-test="mat-table-menu-button"
              mat-icon-button
              [matMenuTriggerFor]="columnMenu"
              (menuOpened)="initOpenedColumnMenuDialog()"
              aria-label="Menu for the table"
              class="mat-table-menu-button"
            >
              <mat-icon data-test="mat-table-menu-icon" [matTooltip]="'tableActions.openColumnsMenu' | translate" class="material-icons"
                >settings</mat-icon
              >
            </button>
          </th>
          <td data-test="columns-menu-button-cell" mat-cell *matCellDef="let row" [class.bg-transparent]="!setStickRowActions"></td>
        </ng-container>

        <tr data-test="table-header-row" mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr
          data-test="table-row"
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          [class.selected-row]="selection.isSelected(row) && highlightSelectedRow"
          (click)="rowClicked(row, $event)"
          (contextmenu)="rowClicked(row, $event)"
          (dblclick)="rowDblClicked(row, $event)"
        ></tr>
      </table>

      <mat-menu data-test="column-menu" #columnMenu="matMenu" class="column-menu">
        <command-bar-search-column-menu
          #columMenuComponent
          (columnsChangedEvent)="setDisplayedColumns($event)"
        ></command-bar-search-column-menu>
      </mat-menu>

      <mat-menu data-test="column-menu" #configurationMenu="matMenu" class="column-menu">
        <command-bar-search-config-menu
          #configurationMenuComponent
          (configChangedEvent)="setConfiguration($event)"
        ></command-bar-search-config-menu>
      </mat-menu>
    </div>
    <mat-paginator
      data-test="paginator"
      #paginator
      [length]="dataSource.length"
      [pageIndex]="0"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      [showFirstLastButtons]="showFirstLastButtons"
      (page)="pageChange()"
    >
    </mat-paginator>
  </div>
</div>

<!-- Highlighting search values -->
<ng-template #normal let-value="value">{{ value === null ? '-' : value }}</ng-template>
<ng-template #searchedWordExists let-value="value">
  <ng-container *ngFor="let letter of value.toString().split(''); let i = index">
    <ng-container
      [ngTemplateOutlet]="shouldHighlight(value, letter) ? highlight : notHighlighted"
      [ngTemplateOutletContext]="{$implicit: letter}"
    ></ng-container>
  </ng-container>
</ng-template>
<ng-template #highlight let-letter>
  <mark [style.background-color]="highlightConfig?.color">{{ letter }}</mark>
</ng-template>
<ng-template #notHighlighted let-letter>{{ letter }}</ng-template>
